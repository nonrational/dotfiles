#!/bin/bash

# Based on Gary Bernhardt's .githelpers
# https://github.com/garybernhardt/dotfiles/blob/master/.githelpers

# Log output:
#
# * 51c333e    (12 days)    <Gary Bernhardt>   add vim-eunuch
#
# Branch output:
#
# * release/v1.1    (13 days)    <Leyan Lo>   add pretty_git_branch
#
# The time massaging regexes start with ^[^<]* because that ensures that they
# only operate before the first "<". That "<" will be the beginning of the
# author name, ensuring that we don't destroy anything in the commit message
# that looks like time.
#
# The log format uses } characters between each field, and `column` is later
# used to split on them. A } in the commit subject or any other field will
# break this.

LOG_HASH="%C(yellow)%h%Creset"
LOG_RELATIVE_TIME="%Cgreen(%ar)%Creset"
LOG_AUTHOR="%C(bold blue)<%an>%Creset"
LOG_REFS="%C(bold red)%d%Creset"
LOG_SUBJECT="%s"

LOG_FORMAT="$LOG_HASH}$LOG_RELATIVE_TIME}$LOG_AUTHOR}$LOG_REFS $LOG_SUBJECT"

BRANCH_PREFIX="%(HEAD)"
BRANCH_REF="%(color:red)%(color:bold)%(refname:short)%(color:reset)"
BRANCH_HASH="%(color:yellow)%(objectname:short)%(color:reset)"
BRANCH_DATE="%(color:green)(%(committerdate:relative))%(color:reset)"
BRANCH_AUTHOR="%(color:blue)%(color:bold)<%(authorname)>%(color:reset)"
BRANCH_CONTENTS="%(contents:subject)"

BRANCH_FORMAT="$BRANCH_PREFIX}$BRANCH_REF}$BRANCH_HASH}$BRANCH_DATE}$BRANCH_AUTHOR}$BRANCH_CONTENTS"

ANSI_BLACK='\033[30m'
ANSI_BLACK_BOLD='\033[0;30;1m'
ANSI_RED='\033[31m'
ANSI_RED_BOLD='\033[0;31;1m'
ANSI_GREEN='\033[32m'
ANSI_GREEN_BOLD='\033[0;32;1m'
ANSI_YELLOW='\033[33m'
ANSI_YELLOW_BOLD='\033[0;33;1m'
ANSI_BLUE='\033[34m'
ANSI_BLUE_BOLD='\033[0;34;1m'
ANSI_MAGENTA='\033[35m'
ANSI_MAGENTA_BOLD='\033[0;35;1m'
ANSI_CYAN='\033[36m'
ANSI_CYAN_BOLD='\033[0;36;1m'
ANSI_WHITE='\033[37m'
ANSI_WHITE_BOLD='\033[0;37;1m'
ANSI_RESET='\033[0m'

show_git_head() {
    git show -p --pretty="tformat:"
}

pretty_git_log() {
    git log --graph --color=never --pretty="tformat:${LOG_FORMAT}" $* |
    pretty_git_format |
    # Hack colors back into pretty-git-log
    sed -Ee "s/( <[A-Za-z ]+> )/$(printf $ANSI_BLUE_BOLD)\1$(printf $ANSI_RESET)/"  |  # author
    sed -Ee "s/( \([0-9]+ [a-z]+\) )/$(printf $ANSI_GREEN)\1$(printf $ANSI_RESET)/" |  # relative date
    sed -Ee "s/( [a-f0-9]{7,12} )/$(printf $ANSI_YELLOW)\1$(printf $ANSI_RESET)/"      |  # abbrev hash
    sed -Ee "s/(  \([^\)]+\) )/$(printf $ANSI_RED_BOLD)\1$(printf $ANSI_RESET)/"       # refs
}

pretty_git_branch() {
    git branch -v --color=always --format=${BRANCH_FORMAT} $* | pretty_git_format
}

pretty_git_branch_sorted() {
    git branch -v --color=always --format=${BRANCH_FORMAT} --sort=-committerdate $* | pretty_git_format
}

pretty_git_format() {
    # Replace (2 years ago) with (2 years)
    sed -Ee 's/(^[^<]*) ago\)/\1)/' |
    # Replace (2 years, 5 months) with (2 years)
    sed -Ee 's/(^[^<]*), [[:digit:]]+ .*months?\)/\1)/' |
    # Line columns up based on } delimiter
    column -s '}' -t |
    # Color merge commits specially
    sed -Ee "s/(Merge (branch|remote-tracking branch|pull request) .*$)/$(printf $ANSI_WHITE_BOLD)\1$(printf $ANSI_RESET)/" |
    # Account for hard cut below
    sed -Ee "s/^/$(printf $ANSI_RESET)/" |
    # Page only if we're asked to.
    if [ -n "$GIT_NO_PAGER" ]; then
        cut -c-${COLUMNS:-160}
    else
        less --quit-if-one-screen --no-init --RAW-CONTROL-CHARS --chop-long-lines
    fi
}

add_wildcard(){
    git ls-files --modified | grep -i $1 | xargs -I{} git add {}
    git ls-files --others --exclude-standard | grep -i $1 | xargs -I{} git add {}
    git ls-files --deleted | grep -i $1 | xargs -I{} git rm {}
}

reset_wildcard(){
    git ls-files --modified | grep -i $1 | xargs -I{} git checkout {}
    git ls-files --others --exclude-standard | grep -i $1 | xargs -I{} git checkout {}
    git ls-files --deleted | grep -i $1 | xargs -I{} git checkout HEAD {}
}

delete_remoteless_branches_interactive(){
    for branch in $(git up | awk '/error:/ {print $1}'); do
        printf "Delete $branch? ";
        read ans;
        [[ "$ans" == "y" ]] && git branch -D $branch;
    done
}

delete_all_my_branches_interactive(){
    for branch in $(git branch | egrep '^\W*aln/'); do
        printf "Delete $branch, both local and origin? ";
        read ans;
        [[ "$ans" == "y" ]] && git branch -D $branch && git push origin :$branch
    done
}

TIMESINCE="function timeSince(date) {\
    var seconds = Math.floor((new Date() - date) / 1000);\
    var interval = Math.floor(seconds / 31536000);\
    if (interval > 1) return interval + \" years\";\
    interval = Math.floor(seconds / 2592000);\
    if (interval > 1) return interval + \" months\";\
    interval = Math.floor(seconds / 86400);\
    if (interval > 1) return interval + \" days\";\
    interval = Math.floor(seconds / 3600);\
    if (interval > 1) return interval + \" hours\";\
    interval = Math.floor(seconds / 60);\
    if (interval > 1) return interval + \" minutes\";\
    return Math.floor(seconds) + \" seconds\";\
}";
